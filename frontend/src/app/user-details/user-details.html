<div class="container py-5">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h3>User Details</h3>
    </div>
  </div>

  <!-- Loader / Error -->
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- User Card -->
  <div *ngIf="user" class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title">{{ user.firstname }} {{ user.lastname }}</h5>
      <p class="card-text"><strong>Username:</strong> {{ user.username }}</p>
      <p class="card-text"><strong>Email:</strong> {{ user.email }}</p>
      <p class="card-text"><strong>Role:</strong> {{ user.role }}</p>
      <p class="card-text">
        <strong>Status:</strong>
        <span class="badge" [ngClass]="user.is_active ? 'bg-success' : 'bg-danger'">
          {{ user.is_active ? 'Active' : 'Inactive' }}
        </span>
      </p>

      <div class="mt-4 d-flex flex-wrap gap-2">
        <a [routerLink]="['/users/edit', user.id]" class="btn btn-primary">Edit</a>
        <button class="btn btn-danger" (click)="deleteUser(user.id)">Delete</button>

        <!-- NEW: Create Student Card button -->
        <button class="btn btn-outline-secondary"
                (click)="createCard()"
                [disabled]="creatingCard">
          <span *ngIf="creatingCard" class="spinner-border spinner-border-sm me-2"></span>
          Create Student Card
        </button>
      </div>

      <!-- NEW: Errors during card creation -->
      <div *ngIf="cardError" class="alert alert-danger mt-3">
        {{ cardError }}
      </div>

      <!-- NEW: Success message + basic card info -->
      <!-- NEW: Success message + basic card info -->
      <div *ngIf="createdCard" class="alert alert-success mt-3">
        Student card created successfully.
        <div class="mt-2">
          <div><strong>Card ID:</strong> {{ createdCard.id }}</div>
          <div><strong>Owner:</strong> {{ createdCard.studentUsername || user.username }}</div>
          <div><strong>Balance (stanje):</strong> {{ createdCard.stanje }}</div>
        </div>
</div>
    </div>
  </div>

  <!-- Meal History -->
  <div *ngIf="!loading">
    <h4 class="mb-3">Meal History</h4>

    <!-- Empty state -->
    <div *ngIf="history.length === 0" class="alert alert-info">
      No meal history found for this user.
    </div>

    <!-- Table -->
    <div *ngIf="history.length > 0" class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Menu Name</th>
            <th>Selected At</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let meal of history; index as i">
            <td>{{ i + 1 }}</td>
            <td>{{ meal.menu_name }}</td>
            <td>{{ meal.selected_at | date: 'medium' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
