<div class="container py-5">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h3>User Details</h3>
    </div>
  </div>

  <!-- Loader / Error -->
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- User Card -->
  <div *ngIf="user" class="card shadow-sm mb-5">
    <div class="card-body">
      <h5 class="card-title">{{ user.firstname }} {{ user.lastname }}</h5>
      <p class="card-text"><strong>Username:</strong> {{ user.username }}</p>
      <p class="card-text"><strong>Email:</strong> {{ user.email }}</p>
      <p class="card-text"><strong>Role:</strong> {{ user.role }}</p>
      <p class="card-text">
        <strong>Status:</strong>
        <span class="badge" [ngClass]="user.is_active ? 'bg-success' : 'bg-danger'">
          {{ user.is_active ? 'Active' : 'Inactive' }}
        </span>
      </p>

      <div class="mt-4 d-flex gap-2">
        <a [routerLink]="['/users/edit', user.id]" class="btn btn-primary">Edit</a>
        <button class="btn btn-danger" (click)="deleteUser(user.id)">Delete</button>
        <!-- NEW: Create Student Card button -->
        <button class="btn btn-outline-secondary" *ngIf="authService.userRole === 'student'"
                (click)="createCard()"
                [disabled]="creatingCard">
          <span *ngIf="creatingCard" class="spinner-border spinner-border-sm me-2"></span>
          Create Student Card
        </button>
      </div>

      <!-- NEW: Errors during card creation -->
      <div *ngIf="cardError" class="alert alert-danger mt-3">
        {{ cardError }}
      </div>

      <!-- NEW: Success message + basic card info -->
      <!-- NEW: Success message + basic card info -->
      <div *ngIf="createdCard" class="alert alert-success mt-3">
        Student card created successfully.
        <div class="mt-2">
          <div><strong>Card ID:</strong> {{ createdCard.id }}</div>
          <div><strong>Owner:</strong> {{ createdCard.studentUsername || user.username }}</div>
          <div><strong>Balance (stanje):</strong> {{ createdCard.stanje }}</div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- Meal History -->
  <div *ngIf="!loading">
    <h4 class="mb-3">Meal History</h4>

    <!-- Empty state -->
    <div *ngIf="history.length === 0" class="alert alert-info">
      No meal history found for this user.
    </div>

    <!-- Table -->
    <div *ngIf="!isAdmin && history.length > 0" class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Menu Name</th>
          <th>Selected At</th>
          <th>Reviews</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let meal of history; index as i">
          <td>{{ i + 1 }}</td>
          <td>{{ meal.menu_name }}</td>
          <td>{{ meal.selected_at | date: 'medium' }}</td>
          <td>
            <div class="d-flex flex-column gap-1">
              <small *ngIf="meal.review">
                <strong>Breakfast:</strong>
                <span class="text-warning">{{ getStarRating(meal.review.breakfast_review) }}</span>
                ({{ meal.review.breakfast_review }}/5)
              </small>
              <small *ngIf="meal.review">
                <strong>Lunch:</strong>
                <span class="text-warning">{{ getStarRating(meal.review.lunch_review) }}</span>
                ({{ meal.review.lunch_review }}/5)
              </small>
              <small *ngIf="meal.review">
                <strong>Dinner:</strong>
                <span class="text-warning">{{ getStarRating(meal.review.dinner_review) }}</span>
                ({{ meal.review.dinner_review }}/5)
              </small>
              <small *ngIf="!meal.review" class="text-muted">No reviews yet</small>
            </div>
          </td>
          <td>
            <button
              class="btn btn-sm"
              [ngClass]="meal.review ? 'btn-outline-primary' : 'btn-primary'"
              (click)="openReviewModal(meal)"
              data-bs-toggle="modal"
              data-bs-target="#reviewModal">
              {{ meal.review ? 'View/Edit Review' : 'Add Review' }}
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">
            {{ selectedMeal?.review ? 'Edit Review' : 'Add Review' }} - {{ selectedMeal?.menu_name }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" *ngIf="selectedMeal">
          <form #reviewForm="ngForm">
            <div class="mb-3">
              <label for="breakfastRating" class="form-label">Breakfast Rating</label>
              <div class="d-flex align-items-center gap-2">
                <div class="rating-stars">
                  <span
                    *ngFor="let star of [1,2,3,4,5]"
                    class="star"
                    [class.active]="star <= reviewData.breakfast_review"
                    (click)="setRating('breakfast_review', star)">
                    ★
                  </span>
                </div>
                <span class="badge bg-secondary">{{ reviewData.breakfast_review }}/5</span>
              </div>
            </div>

            <div class="mb-3">
              <label for="lunchRating" class="form-label">Lunch Rating</label>
              <div class="d-flex align-items-center gap-2">
                <div class="rating-stars">
                  <span
                    *ngFor="let star of [1,2,3,4,5]"
                    class="star"
                    [class.active]="star <= reviewData.lunch_review"
                    (click)="setRating('lunch_review', star)">
                    ★
                  </span>
                </div>
                <span class="badge bg-secondary">{{ reviewData.lunch_review }}/5</span>
              </div>
            </div>

            <div class="mb-3">
              <label for="dinnerRating" class="form-label">Dinner Rating</label>
              <div class="d-flex align-items-center gap-2">
                <div class="rating-stars">
                  <span
                    *ngFor="let star of [1,2,3,4,5]"
                    class="star"
                    [class.active]="star <= reviewData.dinner_review"
                    (click)="setRating('dinner_review', star)">
                    ★
                  </span>
                </div>
                <span class="badge bg-secondary">{{ reviewData.dinner_review }}/5</span>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="saveReview()"
            [disabled]="reviewLoading">
            <span *ngIf="reviewLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
            {{ selectedMeal?.review ? 'Update Review' : 'Save Review' }}
          </button>
        </div>
      </div>
    </div>
  </div>
